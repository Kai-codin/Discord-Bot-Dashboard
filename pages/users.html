<!DOCTYPE html>
<html lang="en">

<head>
    <title>User Management - Bot Panel</title>
    <link rel="stylesheet" href="../file/index.css" />
    <link rel="icon" href="../file/favicon.png" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="//unicons.iconscout.com/release/v4.0.0/css/line.css" />
    <script src="//cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="../file/swal-dark.js"></script>
    <script src="//unpkg.com/@popperjs/core@2"></script>
    <script src="//unpkg.com/tippy.js@6"></script>
    <meta charset="UTF-8" />
</head>

<body>
    <div id="sidebar"><script src="/file/sidebar.js"></script></div>
    
    <main class="main-content">
        <div class="page-header">
            <div>
                <h1 class="page-title"><i class="uil uil-users-alt"></i> User Management</h1>
                <p class="page-subtitle">Manage users and permissions</p>
            </div>
        </div>
        
        <!-- Admin Only Notice -->
        <div id="admin_notice" class="hidden alert alert-danger animate-fadeIn mb-6">
            <i class="uil uil-exclamation-triangle"></i> This page requires admin access.
        </div>

        <!-- Create User Section -->
        <div class="card animate-fadeIn mb-6">
            <div class="card-header">
                <h2 class="card-title"><i class="uil uil-user-plus"></i> Create New User</h2>
            </div>
            <div class="grid grid-cols-4 gap-4">
                <div class="form-group">
                    <label class="form-label">Username</label>
                    <input placeholder="Enter username" type="text" id="new_username" class="form-input">
                </div>
                <div class="form-group">
                    <label class="form-label">Password</label>
                    <input placeholder="Enter password" type="password" id="new_password" class="form-input">
                </div>
                <div class="form-group">
                    <label class="form-label">Role</label>
                    <select id="new_role" class="form-input">
                        <option value="user">User</option>
                        <option value="admin">Admin</option>
                    </select>
                </div>
                <div class="form-group" style="display: flex; align-items: flex-end;">
                    <button onclick="createUser()" class="btn btn-primary" style="width: 100%;">
                        <i class="uil uil-plus"></i> Create User
                    </button>
                </div>
            </div>
        </div>

        <!-- Users List -->
        <div class="table-container animate-fadeIn mb-6">
            <table>
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Username</th>
                        <th>Role</th>
                        <th>Last Login</th>
                        <th style="width: 180px;">Actions</th>
                    </tr>
                </thead>
                <tbody id="users_table">
                    <tr>
                        <td colspan="5">
                            <div class="empty-state">
                                <i class="uil uil-users-alt"></i>
                                <p>Loading users...</p>
                            </div>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>

        <!-- Bot Permissions Section -->
        <div class="card animate-fadeIn">
            <div class="card-header">
                <h2 class="card-title"><i class="uil uil-shield-check"></i> Bot Permissions</h2>
            </div>
            <div class="grid grid-cols-3 gap-4 mb-4">
                <div class="form-group">
                    <label class="form-label">Select User</label>
                    <select id="perm_user_select" onchange="loadUserPermissions()" class="form-input">
                        <option value="">-- Select User --</option>
                    </select>
                </div>
                <div class="form-group" style="grid-column: span 2;">
                    <label class="form-label">Accessible Bots</label>
                    <div id="bot_checkboxes" class="permissions-grid">
                        <p class="text-muted">Select a user to manage permissions</p>
                    </div>
                </div>
            </div>
            <div id="admin_user_notice" class="hidden alert alert-info mb-4">
                <i class="uil uil-info-circle"></i> Admin users have access to all bots automatically.
            </div>
            <button onclick="savePermissions()" id="save_perms_btn" class="btn btn-success" disabled>
                <i class="uil uil-save"></i> Save Permissions
            </button>
        </div>
    </main>
</body>

<script>
let currentUsers = [];
let allBots = [];
let selectedUserId = null;

// Check if user is admin
async function checkAdminAccess() {
    try {
        const response = await fetch('/login/me');
        const data = await response.json();
        if (!data.Success || data.User.role !== 'admin') {
            document.getElementById('admin_notice').classList.remove('hidden');
            document.querySelector('section').innerHTML = `
                <div class="bg-red-500 text-white p-8 rounded-md text-center">
                    <i class="uil uil-exclamation-triangle text-4xl"></i>
                    <h2 class="text-2xl mt-4">Access Denied</h2>
                    <p class="mt-2">This page requires admin privileges.</p>
                    <a href="/home" class="inline-block mt-4 bg-white text-red-500 px-6 py-2 rounded-md">Go to Home</a>
                </div>
            `;
            return false;
        }
        return true;
    } catch (err) {
        console.error('Error checking admin access:', err);
        return false;
    }
}

// Load users
async function loadUsers() {
    try {
        const response = await fetch('/api/users');
        const data = await response.json();
        if (data.Success) {
            currentUsers = data.Data;
            renderUsers();
            populateUserSelect();
        }
    } catch (err) {
        console.error('Error loading users:', err);
    }
}

// Render users table
function renderUsers() {
    const table = document.getElementById('users_table');
    table.innerHTML = currentUsers.map(user => `
        <tr>
            <td>${user.id}</td>
            <td><strong>${user.username}</strong></td>
            <td>
                <span class="badge ${user.role === 'admin' ? 'badge-purple' : 'badge-secondary'}">
                    ${user.role.toUpperCase()}
                </span>
            </td>
            <td>${user.last_login ? new Date(user.last_login).toLocaleString() : 'Never'}</td>
            <td>
                <div class="action-buttons">
                    <button onclick="editUser(${user.id})" class="btn btn-sm btn-primary">
                        <i class="uil uil-edit"></i>
                    </button>
                    <button onclick="resetPassword(${user.id}, '${user.username}')" class="btn btn-sm btn-warning">
                        <i class="uil uil-key-skeleton"></i>
                    </button>
                    <button onclick="deleteUser(${user.id}, '${user.username}')" class="btn btn-sm btn-danger">
                        <i class="uil uil-trash"></i>
                    </button>
                </div>
            </td>
        </tr>
    `).join('');
}

// Populate user select for permissions
function populateUserSelect() {
    const select = document.getElementById('perm_user_select');
    select.innerHTML = '<option value="">-- Select User --</option>' + 
        currentUsers.map(u => `<option value="${u.id}">${u.username} (${u.role})</option>`).join('');
}

// Create user
async function createUser() {
    const username = document.getElementById('new_username').value.trim();
    const password = document.getElementById('new_password').value;
    const role = document.getElementById('new_role').value;

    if (!username || !password) {
        Swal.fire('Error', 'Username and password are required', 'error');
        return;
    }

    try {
        const response = await fetch('/api/users', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ username, password, role })
        });
        const data = await response.json();
        
        if (data.Success) {
            Swal.fire('Success', 'User created successfully', 'success');
            document.getElementById('new_username').value = '';
            document.getElementById('new_password').value = '';
            loadUsers();
        } else {
            Swal.fire('Error', data.Message, 'error');
        }
    } catch (err) {
        Swal.fire('Error', 'Failed to create user', 'error');
    }
}

// Edit user
async function editUser(userId) {
    const user = currentUsers.find(u => u.id === userId);
    if (!user) return;

    const { value: formValues } = await Swal.fire({
        title: `Edit User: ${user.username}`,
        html: `
            <input id="swal-username" class="swal2-input" placeholder="Username" value="${user.username}">
            <select id="swal-role" class="swal2-select">
                <option value="user" ${user.role === 'user' ? 'selected' : ''}>User</option>
                <option value="admin" ${user.role === 'admin' ? 'selected' : ''}>Admin</option>
            </select>
        `,
        focusConfirm: false,
        showCancelButton: true,
        preConfirm: () => ({
            username: document.getElementById('swal-username').value,
            role: document.getElementById('swal-role').value
        })
    });

    if (formValues) {
        try {
            const response = await fetch(`/api/users/${userId}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(formValues)
            });
            const data = await response.json();
            
            if (data.Success) {
                Swal.fire('Success', 'User updated', 'success');
                loadUsers();
            } else {
                Swal.fire('Error', data.Message, 'error');
            }
        } catch (err) {
            Swal.fire('Error', 'Failed to update user', 'error');
        }
    }
}

// Reset password
async function resetPassword(userId, username) {
    const { value: newPassword } = await Swal.fire({
        title: `Reset Password for ${username}`,
        input: 'password',
        inputPlaceholder: 'Enter new password',
        showCancelButton: true,
        inputValidator: (value) => {
            if (!value || value.length < 4) {
                return 'Password must be at least 4 characters';
            }
        }
    });

    if (newPassword) {
        try {
            const response = await fetch(`/api/users/${userId}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ password: newPassword })
            });
            const data = await response.json();
            
            if (data.Success) {
                Swal.fire('Success', 'Password reset successfully', 'success');
            } else {
                Swal.fire('Error', data.Message, 'error');
            }
        } catch (err) {
            Swal.fire('Error', 'Failed to reset password', 'error');
        }
    }
}

// Delete user
async function deleteUser(userId, username) {
    const result = await Swal.fire({
        title: `Delete ${username}?`,
        text: "This action cannot be undone. All permissions will also be removed.",
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#d33',
        confirmButtonText: 'Delete'
    });

    if (result.isConfirmed) {
        try {
            const response = await fetch(`/api/users/${userId}`, {
                method: 'DELETE'
            });
            const data = await response.json();
            
            if (data.Success) {
                Swal.fire('Deleted', 'User has been deleted', 'success');
                loadUsers();
            } else {
                Swal.fire('Error', data.Message, 'error');
            }
        } catch (err) {
            Swal.fire('Error', 'Failed to delete user', 'error');
        }
    }
}

// Load all bots for permissions
async function loadAllBots() {
    try {
        const response = await fetch('/list-apps');
        const data = await response.json();
        if (Array.isArray(data)) {
            allBots = data.map(app => app.App.Name);
        }
    } catch (err) {
        console.error('Error loading bots:', err);
    }
}

// Load user permissions
async function loadUserPermissions() {
    const userId = document.getElementById('perm_user_select').value;
    const container = document.getElementById('bot_checkboxes');
    const saveBtn = document.getElementById('save_perms_btn');
    const adminNotice = document.getElementById('admin_user_notice');
    
    if (!userId) {
        container.innerHTML = '<p class="text-gray-400">Select a user to manage permissions</p>';
        saveBtn.disabled = true;
        adminNotice.classList.add('hidden');
        return;
    }

    selectedUserId = parseInt(userId);
    const user = currentUsers.find(u => u.id === selectedUserId);

    try {
        const response = await fetch(`/api/permissions/user/${userId}`);
        const data = await response.json();
        
        if (data.Success) {
            if (data.Data.isAdmin) {
                adminNotice.classList.remove('hidden');
                saveBtn.disabled = true;
                container.innerHTML = allBots.map(bot => `
                    <label class="checkbox-item">
                        <input type="checkbox" checked disabled>
                        <span>${bot}</span>
                    </label>
                `).join('') || '<p class="text-muted">No bots found</p>';
            } else {
                adminNotice.classList.add('hidden');
                saveBtn.disabled = false;
                const userPerms = data.Data.permissions;
                container.innerHTML = allBots.map(bot => `
                    <label class="checkbox-item">
                        <input type="checkbox" value="${bot}" ${userPerms.includes(bot) ? 'checked' : ''} 
                            class="bot-perm-checkbox">
                        <span>${bot}</span>
                    </label>
                `).join('') || '<p class="text-muted">No bots found</p>';
            }
        }
    } catch (err) {
        console.error('Error loading permissions:', err);
    }
}

// Save permissions
async function savePermissions() {
    if (!selectedUserId) return;

    const checkboxes = document.querySelectorAll('.bot-perm-checkbox:checked');
    const bots = Array.from(checkboxes).map(cb => cb.value);

    try {
        const response = await fetch('/api/permissions/set', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ userId: selectedUserId, bots })
        });
        const data = await response.json();
        
        if (data.Success) {
            Swal.fire('Success', 'Permissions saved', 'success');
        } else {
            Swal.fire('Error', data.Message, 'error');
        }
    } catch (err) {
        Swal.fire('Error', 'Failed to save permissions', 'error');
    }
}

// Initialize
async function init() {
    const isAdmin = await checkAdminAccess();
    if (isAdmin) {
        await loadUsers();
        await loadAllBots();
    }
}

init();
</script>

<script src="../file/index.js"></script>

</html>
